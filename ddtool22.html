<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ddtool11 â€“ CSV Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
h1 { color: #2c3e50; }
.box {
  background: #fff;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 8px;
}
label { font-weight: bold; }
select, input, button {
  margin-top: 5px;
  padding: 6px;
}
button {
  background: #007bff;
  color: #fff;
  border: none;
  cursor: pointer;
}
button:hover { background: #0056b3; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
th, td {
  border: 1px solid #ccc;
  padding: 5px;
  text-align: center;
}
th { background: #eee; }
.anomaly { background: #ffdddd; }
.tooltip {
  border-bottom: 1px dotted black;
  cursor: help;
}
</style>
</head>

<body>

<h1>ğŸ“Š ddtool11 â€“ CSV Analysis Tool</h1>

<div class="box">
  <label class="tooltip" title="Upload a CSV file with headers">
    Upload CSV
  </label><br>
  <input type="file" id="fileInput" accept=".csv">
</div>

<div class="box">
  <label class="tooltip" title="Choose numeric column for analysis">
    Numeric Column
  </label><br>
  <select id="columnSelect"></select><br><br>

  <label class="tooltip" title="Absolute Z-score limit for anomalies">
    Z-score Threshold
  </label><br>
  <input type="number" id="zLimit" value="3" step="0.1"><br>

  <button id="analyzeBtn">Analyze</button>
</div>

<div class="box">
  <h3>ğŸ“ Statistics</h3>
  <div id="stats">No data</div>
</div>

<div class="box">
  <h3>ğŸ” Filter</h3>
  <select id="filterCol"></select>
  <input type="text" id="filterVal">
  <button id="filterBtn">Apply</button>
</div>

<div class="box">
  <h3>ğŸ“„ Data Table</h3>
  <div style="overflow:auto">
    <table id="table"></table>
  </div>
</div>

<div class="box">
  <h3>ğŸ“ˆ Chart</h3>
  <canvas id="chart"></canvas>
</div>

<script>
let headers = [];
let data = [];
let chart = null;

// --- CSV PARSER (ROBUST, SIMPLE) ---
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  headers = lines[0].split(",");
  data = [];

  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(",");
    const row = {};
    headers.forEach((h, idx) => row[h] = values[idx]);
    data.push(row);
  }
}

// --- FILE UPLOAD ---
document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    parseCSV(reader.result);
    setupSelectors();
    renderTable(data);
  };
  reader.readAsText(file);
});

// --- SETUP DROPDOWNS ---
function setupSelectors() {
  const colSel = document.getElementById("columnSelect");
  const filterSel = document.getElementById("filterCol");

  colSel.innerHTML = "";
  filterSel.innerHTML = "";

  headers.forEach(h => {
    colSel.add(new Option(h, h));
    filterSel.add(new Option(h, h));
  });
}

// --- ANALYSIS ---
document.getElementById("analyzeBtn").onclick = () => {
  const col = columnSelect.value;
  const limit = parseFloat(zLimit.value);

  const nums = data
    .map(r => parseFloat(r[col]))
    .filter(v => !isNaN(v));

  const mean = nums.reduce((a,b)=>a+b,0) / nums.length;
  const sd = Math.sqrt(
    nums.reduce((a,b)=>a + Math.pow(b-mean,2),0) / nums.length
  );

  data.forEach(r => {
    const v = parseFloat(r[col]);
    if (isNaN(v)) {
      r._z = "";
      r._a = false;
    } else {
      r._z = ((v - mean) / sd).toFixed(2);
      r._a = Math.abs(r._z) > limit;
    }
  });

  document.getElementById("stats").innerHTML = `
    <b>Mean:</b> ${mean.toFixed(3)}<br>
    <b>Standard Deviation:</b> ${sd.toFixed(3)}<br>
    <span class="tooltip" title="Z = (x âˆ’ mean) / SD">
      Z-score formula
    </span>
  `;

  renderTable(data);
  drawChart(nums, col);
};

// --- TABLE ---
function renderTable(rows) {
  const table = document.getElementById("table");
  table.innerHTML = "";

  let head = "<tr>";
  headers.forEach(h => head += `<th>${h}</th>`);
  head += "<th>Z</th></tr>";
  table.innerHTML += head;

  rows.forEach(r => {
    let row = `<tr class="${r._a ? 'anomaly' : ''}">`;
    headers.forEach(h => row += `<td>${r[h]}</td>`);
    row += `<td>${r._z || ""}</td></tr>`;
    table.innerHTML += row;
  });
}

// --- FILTER ---
document.getElementById("filterBtn").onclick = () => {
  const c = filterCol.value;
  const v = filterVal.value;
  renderTable(data.filter(r => r[c] == v));
};

// --- CHART ---
function drawChart(values, label) {
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: values.map((_,i)=>i+1),
      datasets: [{
        label: label,
        data: values
      }]
    }
  });
}
</script>

</body>
</html>
