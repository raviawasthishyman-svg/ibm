<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ddtool22 â€“ CSV Data Analysis Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f2f4f7;
  padding:20px;
}
h1,h2 { color:#2c3e50; }
.section {
  background:#fff;
  padding:15px;
  margin-bottom:15px;
  border-radius:8px;
}
label { font-weight:bold; }
input, select, button {
  margin-top:5px;
  padding:6px;
}
button {
  background:#007bff;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:hover { background:#0056b3; }
table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th, td {
  border:1px solid #ccc;
  padding:5px;
  text-align:center;
}
th { background:#eee; }
.anomaly { background:#ffd6d6; }
.tooltip {
  border-bottom:1px dotted #000;
  cursor:help;
}
</style>
</head>

<body>

<h1>ğŸ“Š ddtool22 â€“ CSV Analysis (Z-Score & SD)</h1>

<div class="section">
  <label class="tooltip" title="Upload a CSV file with headers">Upload CSV</label><br>
  <input type="file" id="fileInput" accept=".csv">
</div>

<div class="section">
  <label class="tooltip" title="Numeric column for statistics">Numeric Column</label><br>
  <select id="numCol"></select><br><br>

  <label class="tooltip" title="Absolute Z-score threshold">Z-Score Threshold</label><br>
  <input type="number" id="zLimit" value="3" step="0.1"><br>

  <button onclick="analyze()">Analyze</button>
</div>

<div class="section">
  <h2>ğŸ“ Statistics</h2>
  <div id="stats">No data yet</div>
</div>

<div class="section">
  <h2>ğŸ” Filter</h2>
  <select id="filterCol"></select>
  <input type="text" id="filterVal">
  <button onclick="applyFilter()">Apply</button>
</div>

<div class="section">
  <h2>ğŸ“„ Data Table</h2>
  <div style="overflow:auto">
    <table id="table"></table>
  </div>
</div>

<div class="section">
  <h2>ğŸ“ˆ Chart</h2>
  <canvas id="chart"></canvas>
</div>

<script>
let headers = [];
let rows = [];
let chartObj = null;

/* ---------- ROBUST CSV PARSER (QUOTES + COMMAS) ---------- */
function parseCSV(text) {
  const result = [];
  let row = [], field = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"' ) {
      inQuotes = !inQuotes;
    } else if (c === "," && !inQuotes) {
      row.push(field);
      field = "";
    } else if ((c === "\\n" || c === "\\r") && !inQuotes) {
      if (field || row.length) {
        row.push(field);
        result.push(row);
        row = [];
        field = "";
      }
    } else {
      field += c;
    }
  }
  if (field || row.length) {
    row.push(field);
    result.push(row);
  }
  return result;
}

/* ---------- FILE LOAD ---------- */
document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const parsed = parseCSV(reader.result.trim());
    headers = parsed.shift();
    rows = parsed.map(r => {
      const obj = {};
      headers.forEach((h,i)=>obj[h]=r[i]);
      return obj;
    });
    setupSelectors();
    renderTable(rows);
  };
  reader.readAsText(file);
});

/* ---------- SETUP SELECTS ---------- */
function setupSelectors() {
  numCol.innerHTML = "";
  filterCol.innerHTML = "";
  headers.forEach(h => {
    numCol.add(new Option(h,h));
    filterCol.add(new Option(h,h));
  });
}

/* ---------- ANALYSIS ---------- */
function analyze() {
  const col = numCol.value;
  const limit = parseFloat(zLimit.value);

  const values = rows
    .map(r => parseFloat(r[col]))
    .filter(v => !isNaN(v));

  const mean = values.reduce((a,b)=>a+b,0) / values.length;
  const sd = Math.sqrt(
    values.reduce((a,b)=>a+(b-mean)**2,0) / values.length
  );

  rows.forEach(r => {
    const v = parseFloat(r[col]);
    if (isNaN(v)) {
      r._z = "";
      r._a = false;
    } else {
      const z = (v - mean) / sd;
      r._z = z.toFixed(2);
      r._a = Math.abs(z) > limit;
    }
  });

  stats.innerHTML = `
    <b>Mean:</b> ${mean.toFixed(3)}<br>
    <b>Standard Deviation:</b> ${sd.toFixed(3)}<br>
    <span class="tooltip" title="Z = (value âˆ’ mean) / SD">
      Z-Score Formula
    </span>
  `;

  renderTable(rows);
  drawChart(values, col);
}

/* ---------- TABLE ---------- */
function renderTable(data) {
  table.innerHTML = "";
  let head = "<tr>";
  headers.forEach(h=>head+=`<th>${h}</th>`);
  head += "<th>Z</th></tr>";
  table.innerHTML += head;

  data.forEach(r => {
    let tr = `<tr class="${r._a?'anomaly':''}">`;
    headers.forEach(h=>tr+=`<td>${r[h]??''}</td>`);
    tr += `<td>${r._z||''}</td></tr>`;
    table.innerHTML += tr;
  });
}

/* ---------- FILTER ---------- */
function applyFilter() {
  const c = filterCol.value;
  const v = filterVal.value;
  renderTable(rows.filter(r => r[c] == v));
}

/* ---------- CHART ---------- */
function drawChart(vals, label) {
  if (chartObj) chartObj.destroy();
  chartObj = new Chart(document.getElementById("chart"), {
    type:"line",
    data:{
      labels: vals.map((_,i)=>i+1),
      datasets:[{ label, data: vals }]
    }
  });
}
</script>

</body>
</html>
