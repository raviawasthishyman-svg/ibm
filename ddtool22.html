<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ddtool22 – CSV Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
h1 { color:#333; }
.box { background:#fff; padding:15px; margin-bottom:15px; border-radius:6px; }
label { font-weight:bold; }
input, select, button { margin-top:6px; padding:6px; }
button { background:#007bff; color:#fff; border:none; cursor:pointer; }
button:hover { background:#0056b3; }
table { width:100%; border-collapse:collapse; font-size:13px; }
th, td { border:1px solid #ccc; padding:5px; text-align:center; }
th { background:#eee; }
.anomaly { background:#ffdada; }
</style>
</head>

<body>

<h1>ddtool22 – CSV Data Analysis Tool</h1>

<div class="box">
  <label>Upload CSV file</label><br>
  <input type="file" id="fileInput" accept=".csv">
</div>

<div class="box">
  <label>Numeric column</label><br>
  <select id="columnSelect"></select><br><br>

  <label>Z-score threshold</label><br>
  <input type="number" id="zInput" value="3" step="0.1"><br><br>

  <button id="analyzeBtn">Analyze</button>
</div>

<div class="box">
  <h3>Statistics</h3>
  <div id="stats">No data</div>
</div>

<div class="box">
  <h3>Filter</h3>
  <select id="filterColumn"></select>
  <input type="text" id="filterValue">
  <button id="filterBtn">Apply</button>
</div>

<div class="box">
  <h3>Data</h3>
  <div style="overflow:auto">
    <table id="table"></table>
  </div>
</div>

<div class="box">
  <h3>Chart</h3>
  <canvas id="chart"></canvas>
</div>

<script>
let headers = [];
let data = [];
let chart = null;

/* ---------- CSV LOAD ---------- */
document.getElementById("fileInput").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function () {
    const lines = reader.result.trim().split(/\r?\n/);
    headers = lines[0].split(",");

    data = [];
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(",");
      let row = {};
      headers.forEach((h, j) => row[h] = values[j]);
      data.push(row);
    }

    setupSelectors();
    renderTable(data);
  };
  reader.readAsText(file);
});

/* ---------- SETUP ---------- */
function setupSelectors() {
  const colSel = document.getElementById("columnSelect");
  const filterSel = document.getElementById("filterColumn");

  colSel.innerHTML = "";
  filterSel.innerHTML = "";

  headers.forEach(h => {
    colSel.add(new Option(h, h));
    filterSel.add(new Option(h, h));
  });
}

/* ---------- ANALYZE ---------- */
document.getElementById("analyzeBtn").onclick = function () {
  const col = document.getElementById("columnSelect").value;
  const zLimit = parseFloat(document.getElementById("zInput").value);

  const nums = data
    .map(r => parseFloat(r[col]))
    .filter(v => !isNaN(v));

  if (nums.length === 0) {
    alert("Selected column is not numeric.");
    return;
  }

  const mean = nums.reduce((a,b)=>a+b,0) / nums.length;
  const sd = Math.sqrt(nums.reduce((a,b)=>a+(b-mean)**2,0) / nums.length);

  data.forEach(r => {
    const v = parseFloat(r[col]);
    if (isNaN(v)) {
      r._z = "";
      r._a = false;
    } else {
      const z = (v - mean) / sd;
      r._z = z.toFixed(2);
      r._a = Math.abs(z) > zLimit;
    }
  });

  document.getElementById("stats").innerHTML =
    "Mean: " + mean.toFixed(3) + "<br>" +
    "Standard Deviation: " + sd.toFixed(3) + "<br>" +
    "Z = (value − mean) / SD";

  renderTable(data);
  drawChart(nums, col);
};

/* ---------- TABLE ---------- */
function renderTable(rows) {
  const table = document.getElementById("table");
  table.innerHTML = "";

  let head = "<tr>";
  headers.forEach(h => head += "<th>"+h+"</th>");
  head += "<th>Z</th></tr>";
  table.innerHTML += head;

  rows.forEach(r => {
    let tr = "<tr class='"+(r._a ? "anomaly" : "")+"'>";
    headers.forEach(h => tr += "<td>"+(r[h] ?? "")+"</td>");
    tr += "<td>"+(r._z ?? "")+"</td></tr>";
    table.innerHTML += tr;
  });
}

/* ---------- FILTER ---------- */
document.getElementById("filterBtn").onclick = function () {
  const c = document.getElementById("filterColumn").value;
  const v = document.getElementById("filterValue").value;
  renderTable(data.filter(r => r[c] == v));
};

/* ---------- CHART ---------- */
function drawChart(values, label) {
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: values.map((_,i)=>i+1),
      datasets: [{ label: label, data: values }]
    }
  });
}
</script>

</body>
</html>
