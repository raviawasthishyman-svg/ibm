<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ddtool22 – Anomaly Highlighter</title>

<!-- Chart.js (UMD build – reliable) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f0f0;
  padding: 20px;
}
.box {
  background: #ffffff;
  padding: 12px;
  margin-bottom: 12px;
}
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  border: 1px solid #888;
  padding: 5px;
  text-align: center;
}
th {
  background: #e0e0e0;
}
.anomaly {
  background-color: #ffb3b3 !important; /* STRONG RED HIGHLIGHT */
}
</style>
</head>

<body>

<h2>ddtool22 – CSV Anomaly Detection (Z-Score)</h2>

<div class="box">
  <input type="file" id="fileInput" accept=".csv">
</div>

<div class="box">
  Column:
  <select id="columnSelect"></select>
  Z-Score Threshold:
  <input type="number" id="zLimit" value="3" step="0.1">
  <button onclick="analyze()">Analyze</button>
</div>

<div class="box" id="stats">Upload a CSV to begin</div>

<div class="box">
  <table id="dataTable"></table>
</div>

<div class="box">
  <canvas id="chart"></canvas>
</div>

<script>
let headers = [];
let rows = [];
let chart = null;

/* ---------- LOAD CSV ---------- */
document.getElementById("fileInput").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function () {
    const lines = reader.result.trim().split(/\r?\n/);
    headers = lines[0].split(",");

    rows = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const values = lines[i].split(",");
      let obj = {};
      headers.forEach((h, j) => obj[h] = values[j]);
      rows.push(obj);
    }

    setupColumnSelect();
    renderTable(rows);
  };
  reader.readAsText(file);
});

/* ---------- SETUP ---------- */
function setupColumnSelect() {
  columnSelect.innerHTML = "";
  headers.forEach(h => columnSelect.add(new Option(h, h)));
}

/* ---------- ANALYZE & HIGHLIGHT ---------- */
function analyze() {
  const col = columnSelect.value;
  const limit = parseFloat(zLimit.value);

  const nums = rows
    .map(r => parseFloat(r[col]))
    .filter(v => !isNaN(v));

  const mean = nums.reduce((a, b) => a + b, 0) / nums.length;
  const sd = Math.sqrt(
    nums.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / nums.length
  );

  rows.forEach(r => {
    const v = parseFloat(r[col]);
    if (isNaN(v)) {
      r._z = "";
      r._anomaly = false;
    } else {
      const z = (v - mean) / sd;
      r._z = z.toFixed(2);
      r._anomaly = Math.abs(z) > limit;
    }
  });

  document.getElementById("stats").innerHTML =
    "Mean: " + mean.toFixed(3) + "<br>" +
    "Standard Deviation: " + sd.toFixed(3) + "<br>" +
    "Anomaly rule: |Z| > " + limit;

  renderTable(rows);
  drawChart(nums, col);
}

/* ---------- TABLE (ANOMALIES IN RED) ---------- */
function renderTable(data) {
  let html = "<tr>";
  headers.forEach(h => html += "<th>" + h + "</th>");
  html += "<th>Z</th></tr>";

  data.forEach(r => {
    html += "<tr class='" + (r._anomaly ? "anomaly" : "") + "'>";
    headers.forEach(h => html += "<td>" + (r[h] || "") + "</td>");
    html += "<td>" + (r._z || "") + "</td></tr>";
  });

  dataTable.innerHTML = html;
}

/* ---------- CHART ---------- */
function drawChart(values, label) {
  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: values.map((_, i) => i + 1),
      datasets: [{
        label: label,
        data: values
      }]
    }
  });
}
</script>

</body>
</html>
